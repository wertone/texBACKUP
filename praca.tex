\documentclass[a4paper]{book}
\usepackage[utf8]{inputenc}                                      
\usepackage[OT4]{fontenc}  
\usepackage[polish]{babel} 
\usepackage{indentfirst}
\usepackage{graphicx} 
\usepackage{hyperref}
% potrzebny jeżeli korzystamy z listingów
\usepackage{listings}

% formatowanie listingu
\lstset{language=C++, 
	numbers=left, 
	numberstyle=\tiny, 
	%     stepnumber=1, 
	%     numbersep=5pt,
	%	stringstyle=\ttfamily,
	showstringspaces=false,
	keywords={function, foreach, in, end, if, not},
	tabsize=3,
	%	escapeinside={(!}{!)}
}


\frenchspacing

\input{todo.tex}

\title{Tymczasowa strona tytułowa}
\author{Mateusz Stolecki}


\begin{document}
%\kslistofremarks

\cleardoublepage

	
%	\maketitle
\input{front.tex}

%\tableofcontents

\mainmatter

\chapter{Wstęp}
Celem pracy dyplomowej jest zaprojektowanie i implementacja systemu informatycznego, który umożliwiałby gromadzenie oraz przetwarzanie danych generowanych przez kasy sklepowe Aloha. System ten miałby na  celu dostarczenie użytkownikowi informacji o funkcjonowaniu sklepu, w którym aplikacja została zainstalowana. Umożliwi to kompleksowy monitoring i analizę danych sprzedażowych. System będzie pobierał dane generowane przez kasę i poddawał je szczegółowej analizie, która pozwoli na tworzenie z nich struktur  obrazujących rzeczywiste czynności wykonywane przy użyciu kas Aloha (szczególnie popularny model kasy w Stanach Zjednoczonych). Takie przetwarzanie przychodzących danych pozwoli użytkownikowi na wejrzenie w dane szczegółowe konkretnej transakcji, zobaczenie materiału wideo z jej przebiegu oraz generowanie raportów i paragonów. Dzięki takim funkcjonalnościom system powinien umożliwić optymalizację sprzedaży oraz wprowadzanie oszczędności wynikających z usunięcia nieprawidłowości zaistniałych podczas pracy sklepu. Aplikacja będzie składała się z dwóch warstw:
\begin{itemize}
	\item modułu wstępnego przetwarzania danych (PreParser-a)
	\item modułu właściwego przetwarzania danych (Parser-a)
\end{itemize}
PreParser będzie działał jako serwis po stronie użytkownika i wprowadzi konieczność jego instalacji na tzw. kontrolerze w sklepie użytkownika, czyli komputerze gromadzącym dane przychodzące z kas w danym sklepie i poddającym je etapowi wstępnej obróbki (preprasing) oraz wysyłającym dane wynikowe do bazy danych dostarczanej przez twórcę systemu, gdzie dalszym ich przetwarzaniem zajmie się Parser. Zadaniem modułu właściwego przetwarzania danych, będzie obróbka wstępnie przetworzonych informacji przez PreParser i zamiana ich na format mogący być analizowany przez system i zaprezentowany użytkownikowi. Pomysł na stworzenie takiego oprogramowania zrodził się z faktu zajmowania się tą tematyką zawodowo przez autora niniejszej pracy. Autor postanowił wykorzystać wiedzę i doświadczenie zdobyte podczas pracy zawodowej oraz studiów, by stworzyć system mający być częścią oprogramowania 360iQ dostarczanego przez firmę EZUniverse Inc. Dzięki regularnej pracy nad zagadnieniem podczas wykonywaniu obowiązków zawodowych, możliwe było dokładne dostosowanie systemu pod wymagania użytkownika oraz jego solidne przetestowanie przy działu z wykorzystaniem realnych danych i przypadków użycia.
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/360iQ.png}
	\caption{Logo produktu 360iQ stworzonego przez firmę EZUniverse}
	\label{fig:360iq}
\end{figure}
Kolejny rozdział niniejszej pracy zawiera zarys problemu oraz informacje opisujące wykorzystane technologie. Rozdział trzeci wprowadza w temat wymagań funkcjonalnych i niefunkcjonalnych oraz przypadków użycia. Następne rozdziały przybliżą tematykę specyfikacji zewnętrznej oraz wewnętrznej systemu. Poruszone zostaną zagadnienia związane z wykorzystanymi algorytmami oraz metodami radzenia sobie z problematycznymi danymi wejściowymi. Przedstawiony zostanie dodatkowo schemat bazy danych oraz nastąpi omówienie ważniejszych, ze względu na role i funkcjonalność klas. Dwa ostatnie rozdziały poruszą kwestię testowania aplikacji oraz omówiony zostanie przebieg prac i wyniki końcowe wraz z wizją dalszego rozwoju systemu. 

\chapter{Analiza tematu}
Niniejszy rozdział omawia podstawowe zagadnienia związane z realizowanym projektem. Poruszona została kwestia umiejscowienia konwertera danych Aloha w całym systemie 360iQ oraz opisane zostały typy informacji przekazywane przez kasę.
\section{Wprowadzenie}
\subsection{Procesor danych z terminali kas fiskalnych Aloha}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/aloha_pos.png}
	\caption{Przykładowy model kasy Aloha.}
	\label{fig:aloha_pos}
\end{figure}
Terminale kasowe Aloha (rys. \ref{fig:aloha_pos}) są niezwykle popularne w Stanach Zjednoczonych. Umożliwiają one kompleksową obsługę transakcji w sklepie, wpłat oraz wypłat do kasy. Jedną z dodatkowych możliwości terminala jest również dostarczanie informacji o zalogowaniu się pracownika i jego wylogowaniu, co pozwala ustalić intensywność pracy danej osoby, bądź też faktyczne godziny w jakich pracuje. W systemie 360iQ kasy Aloha wykorzystywane są do sklepach sieci Burger King. Terminal kasy przy każdym tzw. zdarzeniu, wysyła informację do nasłuchującego go kontrolera. Zdarzenia te są prostymi akcjami wykonywanymi podczas użytkowania kasy np. dodanie nowego produktu, potwierdzenie przyjęcia płatności. Dzięki gromadzeniu tych akcji po stronie kontrolera istnieje możliwość połączenia ich w zbiory, które będą reprezentować transakcje, wpłaty, wypłaty oraz obecności pracowników. Łączeniem tych zdarzeń w całość zajmuje się moduł aplikacji zainstalowany na kontrolerze zwany PreParserem, który jako część systemu 360iQ funkcjonuję pod nazwą AlohaPreParser. Przetwarza on zdarzenia uwzględniając zawarte w nich informacje dotyczące numeru kasy, rachunku etc.
Po wstępnym przetworzeniu danych zostają one wysłane do bazy ulokowanej po stronie administratora, gdzie przechwytywane są one przez Parser i dokonywana jest właściwa analiza danych i ich przetwarzanie w celu dostarczenia klientowi potrzebnych informacji. 

\subsection{Umiejscowienie w systemie 360iQ}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/EZUniverse.png}
	\caption{Logo firmy EZUniverse Inc.}
	\label{fig:EZUniverse}
\end{figure}
AlohaPreParser oraz AlohaParser są bezpośrednimi składowymi systemu systemu 360iQ dostarczanemu przez firmę EZUniverse (rys. \ref{fig:EZUniverse}). System ten składa się z całej infrastruktury nakierowanej na dostarczenie klientowi maksymalnej liczby informacji mogących wesprzeć funkcjonowanie biznesu klienta. Wspierane są duże ilości modeli kas, które mogą być zainstalowane w klepie klienta, między innymi:
\begin{itemize}
	\item Aloha
	\item Micros
	\item Sicom
	\item Radiant
	\item Subshop2000
	\item ProfiTrack
	\item Panasonic7900
	\item Comtrex
	\item Gilbarco
	\item Par
	\item SubwayPOS
\end{itemize}

Dzięki wsparciu dla dużej ilości modeli kas oraz współpracy z największymi sieciami sklepów (np. Subway, Burger King) system 360iQ jest kompleksowa platformą do wspomagania biznesu klienta.
\subsection{Dane wejściowe}
Danymi wejściowymi dostarczanymi do kontrolera są pojedyncze zdarzenia zapisane w formacie XML.
Format przychodzących danych omówiony zostanie na podstawie następującego zdarzenia (listing \ref{lst:przykladoweZdarzenieAloha}).  
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	<SpyMessage TerminalID="3" EventTime="18:00:38" EmployeeID="139" EmployeeName="JAMES BOND" ManagerID="0" ManagerName="" TableID="3132860" CheckID="3145860" TransactionTypeID="8" TransactionType="ADD_ITEM" Description="SM FRY" Amount="1.99" Quantity="1" Sender="192.168.0.101" ReceivedOn="2017/03/05 00:00:52.042" />
	\end{lstlisting}
	\caption{Przykładowe zdarzenie - dane wejściowe Aloha.}
	\label{lst:przykladoweZdarzenieAloha}
\end{figure}
Opisuje ono akcję dodania nowego przedmiotu do rachunku o numerze 3145860. Możemy nad podstawie przedstawionego listingu ustalić również, że dane zdarzenie miało miejsce o godzinie 18:00:38 oraz przedmiot SM FRY został dodany do rachunku przez pracownika JAMES BOND. Na podstawie tak przedstawionych danych wejściowych moduł przetwarzania wstępnego jest w stanie budować całe zestawy transakcji, które zawierają szereg zdarzeń podobnych temu wyżej przedstawionemu. Dzięki tak pogrupowanym danym, zamiana zwykłych zdarzeń z terminala na struktury mogące być poddane analizie jest znacznie uproszczona. Terminal generuje również dodatkowe dane przechwytywane przez kontroler zwane słownikami. Słowniki są zestawami danych zapisanych w formacie XML niosącymi informacje o specyficznych cecha danego sklepu, np. promocjach, identyfikatorach produktów, bądź podatkach. Przykładowe słowniki przedstawiono na listingach w skróconej formie, gdyż całe pliki potrafią zawierać znaczne ilości informacji (Kategorie produktów: \ref{lst:przykladowySlownikProduktow}, Lista promocji: \ref{lst:przykladowySlownikPromocji})
\begin{figure}
	\begin{lstlisting}[frame=single, breaklines=true]
	<ItemCategoryMessage>
	<Item ItemId="112" ItemName="DELETE" Price="5.89">
	<Category CategoryId="96" CategoryName="WHOPPER  LINE" />
	<Category CategoryId="68" CategoryName="SANDWICHES" />
	<Category CategoryId="55" CategoryName="ALL ITEMS" />
	<Category CategoryId="57" CategoryName="DISCOUNTABLE ITEMS" />
	<Category CategoryId="56" CategoryName="ALL ITEMS EXCEPT CMB" />
	<Category CategoryId="313" CategoryName="ANY SANDWICH" />
	<Category CategoryId="1" CategoryName="FOOD" />
	</Item>
	<Item ItemId="2692" ItemName="LG FLOAT" Price="2.79">
	<Category CategoryId="71" CategoryName="DRINKS" />
	<Category CategoryId="55" CategoryName="ALL ITEMS" />
	<Category CategoryId="57" CategoryName="DISCOUNTABLE ITEMS" />
	<Category CategoryId="56" CategoryName="ALL ITEMS EXCEPT CMB" />
	<Category CategoryId="1" CategoryName="FOOD" />
	</Item>
	<Item ItemId="392" ItemName="WRP HM CSP" Price="0">
	<Category CategoryId="68" CategoryName="SANDWICHES" />
	<Category CategoryId="310" CategoryName="Bearcat Sandwiches" />
	<Category CategoryId="55" CategoryName="ALL ITEMS" />
	<Category CategoryId="57" CategoryName="DISCOUNTABLE ITEMS" />
	<Category CategoryId="56" CategoryName="ALL ITEMS EXCEPT CMB" />
	<Category CategoryId="1" CategoryName="FOOD" />
	</Item>
	<Item ItemId="484" ItemName="WRP BLT CSP" Price="3.49">
	<Category CategoryId="55" CategoryName="ALL ITEMS" />
	<Category CategoryId="57" CategoryName="DISCOUNTABLE ITEMS" />
	<Category CategoryId="56" CategoryName="ALL ITEMS EXCEPT CMB" />
	<Category CategoryId="25" CategoryName="ALL SALADS" />
	<Category CategoryId="1" CategoryName="FOOD" />
	</Item>
	<Item ItemId="5748" ItemName="AVOCADO RAN" Price="0">
	<Category CategoryId="55" CategoryName="ALL ITEMS" />
	<Category CategoryId="57" CategoryName="DISCOUNTABLE ITEMS" />
	<Category CategoryId="56" CategoryName="ALL ITEMS EXCEPT CMB" />
	<Category CategoryId="1" CategoryName="FOOD" />
	</Item>
	</ItemCategoryMessage>
	\end{lstlisting}
	\caption{Przykładowy słownik produktów w formacie XML - wersja skrócona.}
	\label{lst:przykladowySlownikProduktow}
\end{figure}


</Item>
\begin{figure}
	\begin{lstlisting}[frame=single, breaklines=true]
	<PromotionMessage>
	<Item ItemId="7592" ItemName="Items" Price="0">
	<Promotion PromotionId="6485" PromotionVersion="1941" PromotionName="6485*$5C'wich Ml 2" />
	<Promotion PromotionId="118" PromotionVersion="999" PromotionName="Local Combos" />
	<Promotion PromotionId="139" PromotionVersion="2655" PromotionName="Bacon King" />
	<Promotion PromotionId="101" PromotionVersion="689" PromotionName="Whopper Combo" />
	<Promotion PromotionId="101" PromotionVersion="744" PromotionName="Whopper Combo" />
	<Promotion PromotionId="101" PromotionVersion="749" PromotionName="Whopper Combo" />
	<Promotion PromotionId="110" PromotionVersion="2444" PromotionName="FISH COMBO" />
	<Promotion PromotionId="282" PromotionVersion="169" PromotionName="Free Kids Combo" />
	<Promotion PromotionId="104" PromotionVersion="694" PromotionName="Whopper Jr. Combo" />
	<Promotion PromotionId="104" PromotionVersion="746" PromotionName="Whopper Jr. Combo" />
	<Promotion PromotionId="108" PromotionVersion="693" PromotionName="Orig. Chicken Combo" />
	<Promotion PromotionId="108" PromotionVersion="789" PromotionName="Orig. Chicken Combo" />
	<Promotion PromotionId="160" PromotionVersion="900" PromotionName="Grilled Ckn Sw Combo" />
	<Promotion PromotionId="160" PromotionVersion="2447" PromotionName="Grilled Ckn Sw Combo" />
	<Promotion PromotionId="29142" PromotionVersion="160" PromotionName="$1.99 Kids Combo" />
	<Promotion PromotionId="10012" PromotionVersion="947" PromotionName="5 FOR $4" />
	<Promotion PromotionId="10012" PromotionVersion="1372" PromotionName="5 FOR $4" />
	<Promotion PromotionId="10012" PromotionVersion="1866" PromotionName="5 FOR $4" />
	<Promotion PromotionId="28802" PromotionVersion="1951" PromotionName="8802*$4 2Cwich ML" />
	<Promotion PromotionId="147" PromotionVersion="747" PromotionName="Homestyle Cb" />
	<Promotion PromotionId="9579" PromotionVersion="985" PromotionName="9579*2/$10 Wpr ML" />
	<Promotion PromotionId="283" PromotionVersion="1351" PromotionName="Kids Breakfast Meal" />
	<Promotion PromotionId="234" PromotionVersion="94" PromotionName="Dbl Biscuit Combo" />
	<Promotion PromotionId="221" PromotionVersion="89" PromotionName="Crois'wich Combo" />
	<Promotion PromotionId="221" PromotionVersion="90" PromotionName="Crois'wich Combo" />
	<Promotion PromotionId="221" PromotionVersion="93" PromotionName="Crois'wich Combo" />
	</Item>
	</PromotionMessage>
	\end{lstlisting}
	\caption{Przykładowy słownik listy promocji w formacie XML - wersja skrócona.}
	\label{lst:przykladowySlownikPromocji}
\end{figure}
Słowniki te gromadzone są przez moduł wstępnego przetwarzania danych i wykorzystywane w ich analizie i algorytmach mających na celu dokonanie odpowiednich poprawek w danych transakcyjnych (szczegółowo ten temat został poruszony w rozdziale traktującym o wykorzystanych algorytmach).
\subsection{Typy zdarzeń generowanych przez kasę Aloha}
Kasa Aloha jest zdolna do wygenerowania szeregu typów zdarzeń. Są to między innymi:
\begin{itemize}
	\item Zalogowanie pracownika w kasie
	\item Wylogowanie pracownika z kasy
	\item Przerwa w pracy
	\item Zakończenie przerwy w pracy
	\item Otwarcie kasy
	\item Dodanie nowego przedmiotu do transakcji
	\item Anulowanie dodanego przedmiotu
	\item Usunięcie przedmiotu z transakcji
	\item Otwarcie nowego zamówienia
	\item Drukowanie rachunku
	\item Zamknięcie zamówienia
	\item Ponowne otwarcie zamówienia
	\item Przyjęcie płatności
	\item Autoryzacja płatności
	\item Odrzucenie płatności
	\item Modyfikacja płatności
	\item Usunięcie płatności
	\item Dodaj promocje
	\item Usuń promocje
	\item Wartość podatku
	\item Wartość netto transakcji
	\item Wartość brutto transakcji
	\item Dodatek do potrawy
\end{itemize}
Jest to lista wszystkich obsługiwanych typów zdarzeń. Są one identyfikowane przez PreParser na podstawie przypisanych im unikalnych identyfikatorów. Istnieje  jeden typ zdarzenia, który nie został uwzględniony w wyżej wymienionej liście, mianowicie zdarzanie nie będące elementem transakcji zakończonej sprzedażą. Takie przypadki to tzw. transakcje typu "NOSALE" i są  one analizowane z wykorzystaniem szczególnego podejścia. Jest ono szerzej opisane w następnych rozdziałach.
\subsection{Etap wstępnego przetwarzania}
Każdy sklep korzystający z oprogramowania będącego przedmiotem niniejszej pracy wymaga instalacji specjalnego modułu działającego jako serwis na komputerze zwanym kontrolerem. Urządzenie to gromadzi zdarzenia generowane przez kasy działające w obrębie omawianego sklepu. Odebrane informacje są przechwytywane przez działający w systemie moduł wstępnego przetwarzania, który poddaje je wstępnej analizie. Możemy wyodrębnić kluczowe etapy składające się na przeprowadzenie wspomnianego procesu:
\begin{itemize}
	\item Sprawdzanie danych pod kątem duplikatów ich i odpowiednie odfiltrowanie
	\item Analiza możliwości wystąpienia niezamkniętych lub błędnych transakcji ich odpowiednia obsługa
	\item Grupowanie zdarzeń przychodzących z kasy w kolekcje związane z jedną transakcją
	\item Poszukiwanie transakcji, które zostały ponownie i sprawdzanie czy wymagana jest korekcja cen produktów lub płatności
	\item Przetwarzanie całych grup transakcji, rozbudowa zdarzeń z wykorzystaniem algorytmów analizy promocji oraz kategorii produktów
	\item Konwersja zgrupowanych zdarzeń na obiekty XML (Transakcje, Wpłaty/Wypłaty z kasy, Obecności pracowników)
	\item Wysyłanie XML-i do bazy danych w celu ich przetworzenia przez moduł właściwego przetwarzania
\end{itemize}
\subsection{Etap właściwego przetwarzania}
Po wstępnym przetworzeniu danych, gdy moduł wstępnego procesowania informacji przekaże je do bazy danych udostępnianej przez administratora systemu, są one przechwytywane przez działający w środowisku dostarczyciela usługi moduł właściwego przetwarzania danych. Pobiera on z tabel dane w formacie XML, które dzięki wstępnej pracy wykonanej przez PreParser są już odpowiednio pogrupowane i oznaczone. Umożliwia to Parserowi zejście poziom niżej w analizie danych, podczas gdy PreParser analizował zdarzenia pod kątem grupowania ich w struktury, Parser może analizować same zdarzenia i wyciągać z nich informacje, które są konieczne do zbudowania wyczerpującego opisu transakcji, bądź innego zdarzenia, które miało miejsce na kasie.
Moduł ten analizuje każde zdarzenie i krok po kroku tworzy obiekt, który na sam koniec procesowania danych zostanie umieszczony w wynikowej bazie. Udostępnia ona bezpośrednio dane mogące być analizowane przez klienta za pośrednictwem specjalnej aplikacji webowej będącej jest częścią systemu 360iQ. Schemat analizy danych przez moduł właściwego przetwarzania wygląda następująco:
\begin{itemize}
\item Sprawdzanie danych pod kątem duplikatów ich i odpowiednie odfiltrowanie
\item Wykrywanie typu zdarzenia jakie zostało zgrupowane w wejściowy XML: (Transakcja, Wpłata/Wypłata, Obecność pracownika)
\item Uruchamianie odpowiedniego schematu przetwarzania zależnie od wykrytego typu wiadomości
\item Analiza danych w formacie XML krok po kroku i tworzenie cyfrowego modelu będącego odpowiednikiem realnej czynności wykonanej przez pracownika sklepu.
\item Sprawdzanie poprawności stworzonych modeli i dokonywanie koniecznych poprawek, jak również oznaczenie tych, które zawierają wartości odbiegające od normy (ten fakt jest później odpowiednio prezentowany użytkownikowi w aplikacji webowej)
\item Generowanie paragonów do wglądu przez klienta
\item Wysyłanie przetworzony modeli do odpowiednich tabel wynikowej bazy danych w zależności od typu przetwarzanych wiadomości.
\end{itemize}
\subsection{Przypadki niestandardowe}
Terminale kasowe Aloha są dość bogate w przypadki, które można uznać za niestandardowe. Do najczęstszych takich sytuacji możemy zaliczyć:
 \begin{itemize}
 	\item Wadliwe dane wejściowe
 	\item Niezamknięte transakcje
 	\item Dodawanie przedmiotów do rachunku z użyciem ich pełnej nazwy oraz późniejsze usuwanie wykorzystując ich skrócone nazwy
 	\item Dodawanie promocji bez uwzględnienia odpowiednich przedmiotów, które dodana promocja powinna dodawać
 	\item W regionach innych niż Stany Zjednoczone częstym problemem jest brak informacji o podatkach
 \end{itemize}
\subsubsection{Wadliwe dane wejściowe}
Z racji faktu, że moduł wstępnego przetwarzania otrzymuje dane z terminali kasowych Aloha w formacie XML, często zdarza się sytuacja, że jest on wadliwy (np. ucięty), lub też występują jego duplikaty. W takich przypadkach PreParser ustawia odpowiednie statusy tych wiadomości (mogą być one potem zweryfikowane przez użytkownika) i pomija je w procedurze wstępnej analizy.
\subsubsection{Niezamknięte transakcje}
Jednym z najrzadziej występujących przypadków niestandardowych jest sytuacja, gdy mamy do czynienia z niezamkniętą transakcją. Dzieje się to wtedy, gdy otwierana jest transakcja, lecz nie przychodzi zdarzenie oznaczające jej zamknięcie (w Aloha jest to: "CLOSECHECK"). W takiej sytuacji moduł wstępnego przetwarzania ustawiana taką transakcję w stan oczekiwania, który trwa 24 godziny. Jeśli do tego czasu przyjdzie zdarzenie zamykające daną transakcję, to zostanie ona zatwierdzona i przesłana do dalszej analizy, w przeciwnym razie nastąpi jej usunięcie z kolejki oczekujących i oznaczenie jako błędnej danej wejściowej, by użytkownik mógł samodzielnie się jej przyjrzeć.
\subsubsection{Dodawanie przedmiotów do rachunku z użyciem ich pełnej nazwy oraz późniejsze usuwanie wykorzystując ich skrócone nazwy}
Przedmioty dodawane przez kasę Aloha do rachunków niestety często charakteryzują się niejednolitym nazewnictwem. Ten sam przedmiot może być nazywany z wykorzystaniem:
 \begin{itemize}
	\item nazwy skróconej
	\item pełnej nazwy przedmiotu
	\item ID przedmiotu, bądź jego oznaczenia kodowego
\end{itemize}
Powoduje to problemy przy usuwaniu z rachunku już dodanych przedmiotów. Przedmiot dodany do transakcji pod nazwą X może być z niej usuwany pod nazwą Y. W celu uzyskania spójności i powiązania ze sobą przedmiotów wykorzystywany jest algorytm rozszerzania danych przekazywanych przez zdarzenie. Korzysta on ze słownika kategorii przedmiotów, który jest dostarczany raz dziennie przez właściciela sklepu jako specjalne zdarzenie terminala Aloha i przechowywany przez kontroler. Dzięki temu słownikowi możliwe jest powiązanie ze sobą tych samych przedmiotów występujących pod różną nazwą, wykorzystując fakt, że każdy przedmiot ma swoje unikalne ID, które jest udostępniane za pośrednictwem słownika kategorii produktów. Takie rozwiązanie gwarantuje, że w wynikowej transakcji przedmioty będą powiązane i usunięte w sposób prawidłowy niezależnie od zastosowania pełnej, bądź jego skróconej nazwy.
\subsubsection{Dodawanie promocji bez uwzględnienia odpowiednich przedmiotów, które dodana promocja powinna dodawać}
Niezbyt przyjazną cechą terminala Aloha jest obsługa dodawania promocji bez uwzględnienia przedmiotów wchodzących w jej skład. W takim wypadku konieczne jest dodanie przedmiotów do transakcji, których dotyczy dana promocja, dzięki czemu zachowana zostanie zgodność danych z realnie sprzedanymi przedmiotami po stronie sklepu. Dodawanie przedmiotów przez moduł wstępnego przetwarzania realizowane jest przy użyciu słownika promocji dostarczanego przez klienta dla każdego sklepu. Pozwala on zidentyfikować nazwę promocji i rozszerzyć XML z transakcją o potrzebne przedmioty. 
\subsubsection{W regionach innych niż Stany Zjednoczone częstym problemem jest brak informacji o podatkach}
Problem ten objawia się sytuacją, gdy w zdarzeniu wystawianym przez terminal mającym typ "TAX" pojawia się zerowa wartość podatku. W tej sytuacji, by uzyskać prawidłową cenę końcową z wliczoną już wartością podatku, konieczne jest wczytanie dodatkowego słownika przechowującego wartości podatków dla każdego z przedmiotów. Takie rozwiązanie pojawia się w sytuacji, gdy oprogramowanie działa w krajach gdzie system podatkowy znacząco różni się od tego, który obowiązuje w Stanach Zjednoczonych. 
\section{Opis technologii i wykorzystanych narzędzi}
\subsection{Środowisko pracy i język programowania}
Projekt został zrealizowany przy użyciu technologii .NET oraz języka C\#.
Wielokrotnie podczas przeglądania kodu źródłowego projektu można również napotkać skrypty pisane w języku T-SQL, w celu komunikacji z bazą danych.
Całość projektu została napisana w środowisku Visual Studio 2017, przy czym korzystano również z Visual Studio Code w celu analizy danych XML oraz szybkiego przeglądania plików tekstowych.
Do administrowania i zarządzania bazą danych wykorzystano Microsoft SQL Server Management Studio 2016. 
\subsection{Baza danych}
Serwerem bazy danych był Microsoft SQL Server 2016 w wersji Express zainstalowany na lokalnym komputerze. Dokonano połączenia tabel koniecznych do pracy modułu wstępnego przetwarzania i tych niezbędnych do funkcjonowania jednostki realizującej właściwe procesowanie danych.
Dzięki takiemu rozwiązaniu można było testować działanie całego systemu na lokalnym komputerze bez konieczności korzystania z osobnego komputera, który miałby pełnić funkcję kontrolera.
Dane wykorzystywane w niniejszym projekcie są backupami realnych danych źródłowych zaczerpniętych z codziennej pracy systemu u klienta. Pozwala to testować i przedstawić pracę niniejszego projektu w jego naturalnych warunkach i w starciu z prawdziwymi danymi generowanymi przez sklepy w Stanach Zjednoczonych,
\subsection{Moduły wspierające}
Opisywana w niniejszej pracy aplikacja jest wspierana przez następujące oprogramowanie, które jest częścią systemy 360iQ i zostało opracowane przez firmę EZUniverse:
 \begin{itemize}
 	\item AlohaSpyRelay
 	\item EZ360DataInterface
 \end{itemize}
\subsubsection{AlohaSpyRelay}
AlohaSpyRelay jest aplikacją zapewniającą transmisje danych z kasy Aloha do kontrolera gdzie zainstalowany jest moduł wstępnego przetwarzania. Pobiera ona dane bezpośrednio z terminala, zamienia ja na zdarzenia zapisane w formacie XML i przekazuje do kontrolera.
\subsubsection{EZ360DataInterface}
EZ360DataInterface jest łącznikiem pomiędzy modułem wstępnego przetwarzania i częścią odpowiadająca za właściwe przetwarzanie. Po wstępnym przetworzeniu danych przez PreParser istnieje konieczność wysłania ich do bazy danych dostarczanej przez administratora systemu, tym właśnie zajmuje się opisywana aplikacja. Moduł wstępnego przetwarzania przygotowuje gotową paczkę danych do wysłania i powiadamia EZ360DataInterface, że są dane do wysyłki. Aplikacja przechwytuje dane od PreParsera i wysyła je zgodnie ze skonfigurowanymi w jej ustawieniach wytycznymi.
\chapter{Wymagania}
Rozdział ten opisuje wymagania konieczne do uruchomienia oprogramowania po stronie kontrolera jak i administratora aplikacji. Przedstawione zostały również przypadki użycie wraz ze stosownym komentarzem.
\section{Wymagania funkcjonalne}
\subsection{Moduł wstępnego przetwarzania danych - PreParser}
\begin{itemize}
	\item Serwis powinien być wstanie odczytywać pobrać dane z lokalnej bazy danych kontrolera gdzie przechowywane są informację o zdarzeniach, które nadesłał terminal Aloha
	\item Powinna istnieć możliwość przetwarzania dany na etapie wstępnej analizy w celu eliminacji duplikatów i wadliwych wiadomości
	\item Kluczową kwestią jest zastosowanie algorytmów dodających potrzebne produkty z promocji oraz rozszerzające nazwy wspomnianych wcześniej produktów, by można było je łatwo ze sobą powiązać
	\item Serwis powinien informować użytkownika na bieżąco o stanie swojej aktywności za pośrednictwem komunikatów w pliku logów.
	\item Serwis powinien być zdolny grupować wiadomości w kolekcje i konwertować je na odpowiednio zdefiniowane XML-e, a następnie wysyłać je do bazy danych po stronie administratora, by mogły być one dalej analizowane
\end{itemize}
\subsection{Moduł właściwego przetwarzania danych - Parser}
\begin{itemize}
	\item Aplikacja powinna móc odczytywać dane z odpowiednich tabel w bazie danych, gdzie w sposób ciągły pojawiają się nowe dane przysyłane z bliżej nie określonej liczby kontrolerów, gdzie zostały one wstępnie obrobione przez moduł wstępnego przetwarzania
	\item Oprogramowanie musi wspierać różne typy przychodzących wiadomości (transakcje, wpłaty/wypłaty, obecności pracowników) i stosować dla nich właściwe formy analizy i przetwarzania
	\item Wynikowe dane powinny zostać zapisane w bazie danych, z której może korzystać aplikacja webowa dostarczana jako element systemu 360iQ i opracowana przez firmę EZUniverse i prezentująca wyniki użytkownikowi w przyjaznej dla niego formie. Rezultat przetwarzania powinien być możliwie jak najdokładniejszym odwzorowaniem zdarzenia jakie zaszło w danej chwili czasu na kasie w sklepie użytkownika. Ważne jest zachowanie odpowiednich stref czasowych i synchronizacja czasu wideo.
	\item Oprogramowanie powinno udostępniać prosty i intuicyjny interfejs użytkownika
	\item W przypadku wystąpienia błędu podczas analizy danych, aplikacja powinna zamieści odpowiednią informację na ekranie interfejsu użytkownika
\end{itemize}
\section{Wymagania niefunkcjonalne}
\subsection{Moduł wstępnego przetwarzania danych - PreParser}
\begin{itemize}
	\item Stabilnie działający serwis po stronie kontrolera
	\item Personalizacja za pomocą jednego pliku konfiguracyjnego
	\item Prosty sposób instalacji oraz włączania serwisu
	\item Szczegółowy system logów pomagający w diagnostyce usterek i monitoringu działania aplikacji
	\item Niskie wymagania sprzętowe, serwis powinien się uruchamiać i pracować bez widocznych strat na wydajności będąc zainstalowanym na stosunkowo taniej i mało wydajnej maszynie
\end{itemize}
\subsection{Moduł właściwego przetwarzania danych - Parser} 
 \begin{itemize}
 	\item Stabilnie działająca aplikacja desktopowa z intuicyjnym interfejsem użytkownika
 	\item Pełne wsparcie dla przetwarzania danych z kas Aloha oraz integracja z pozostałymi parserami z innych kas działającymi w systemie
 	\item Łatwość wystartowania i zastopowania aplikacji
 	\item Dążenie do jak najniższego wykorzystania zasobów systemu, w którym aplikacja jest zainstalowana
 \end{itemize}
\section{Analiza przypadków użycia (diagramy UML)}
W niniejszej sekcji zaprezentowano przypadki użycia dla modułu wstępnego przetwarzania (rys. \ref{fig:przypadki_uzycia_preparser}) oraz dla części odpowiadającej za właściwe przetwarzanie (rys. \ref{fig:przypadki_uzycia_parser}).
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/przypadki_uzycia_preparser.png}
	\caption{Przypadki użycia - moduł wstępnego przetwarzania.}
	\label{fig:przypadki_uzycia_preparser}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/przypadki_uzycia_parser.png}
	\caption{Przypadki użycia - moduł właściwego przetwarzania.}
	\label{fig:przypadki_uzycia_parser}
\end{figure}
\chapter{Specyfikacja zewnętrzna}
Rozdział ten opisuje wymagania sprzętowe i programowe, które należy spełnić, by zapewnić poprawne funkcjonowanie aplikacji. Poruszone zostały kwestie instalacji i administracji poszczególnymi modułami oprogramowania oraz temat zabezpieczeń.
\section{Wymagania sprzętowe i programowe}
Opisywana aplikacja została przetestowana, na dwóch konfiguracjach sprzętowych:
 \begin{itemize}
	\item Komputer stacjonarny:
	\subitem Procesor - i5 4690K @ 4.5 GHz, 4.0GHz Uncore
	\subitem Pamięć RAM - 8GB DDR3 @ 2400MHz CL11 T1
	\subitem Dysk - SSD 128 GB TLC
	\subitem System operacyjny - Windows 10 PRO
	\item Laptop:
	\subitem Procesor - i5 7200U @ 2.5 GHz
	\subitem Pamięć RAM - 16GB DDR4 @ 2133MHz CL15
	\subitem Dysk - SSD 256 GB MLC
	\subitem System operacyjny - Windows 10 PRO
\end{itemize}
Obydwie konfiguracje gwarantowały satysfakcjonującą płynność i szybkość działania aplikacji.
Na podstawie testów z użyciem wyżej wymienionych zestawów zdefiniowano przybliżone wymagania sprzętowe oraz programowe:
\begin{itemize}
	\item Minimalne wymagania sprzętowe:
	\subitem Procesor - i3 2 generacji Intel Core lub odpowiednik AMD
	\subitem Pamięci RAM - 4GB pamięci operacyjnej
	\subitem Dysk - 100mb wolnej przestrzeni dyskowej
	\subitem Stały dostęp do internetu
	\item Minimalne wymagania programowe:
	\subitem System operacyjny - Windows w wersji 7 lub nowszej
	\subitem Microsoft SQL Server Management Studio oraz MS SQL Server w wersji 2012 lub nowszej
	\subitem .NET Framework w wersji 3.5 lub nowszej
\end{itemize}
\section{Instalacja}
\subsection{Instalacja PreParser-a na kontrolerze u klienta}
W celu zainstalowania  modułu wstępnego przetwarzania danych należy uruchomić plik EZ360PreParserService.Setup.v.VERSION.exe, gdzie VERSION jest numerem wersji.
Uruchomionony zostanie instalator serwisu (rys. \ref{fig:preparser_installation_part1}). W momencie wciśnięcia przycisku Install, instalator rozpocznie wgrywanie PreParser na kontroler. Po zakończeniu proces powinien zostać wyświetlony ekran informujący o poprawnie zakończonej instalacji serwisu (rys. \ref{fig:preparser_installation_part2})
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/preparser_installation_part1.png}
	\caption{Instalacja modułu wstępnego przetwarzania - początek instalacji.}
	\label{fig:preparser_installation_part1}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/preparser_installation_part2.png}
	\caption{Instalacja modułu wstępnego przetwarzania - koniec instalacji.}
	\label{fig:preparser_installation_part2}
\end{figure}
Następnie należy dokonać konfiguracji zainstalowanego serwisu. W tym celu otwieramy plik configuration.json. Powinien on mieć format przedstawiony na listingu \ref{lst:przykladowyPlikKonfiguracyjnyPreParser}.
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	{
	"ProcessID": 636298774975,
	"ParserType": "ALOHA",
	"ObjectsConnectionString": "Data Source = server; User ID = sa; Password = sa_password; Initial Catalog = EZ360Objects;",
	"CommunicationConnectionString": "Data Source = server; User ID = sa; Password = sa_password; Initial Catalog = EZ360Communication;",
	"TransactionWebservice": "http://localhost:65059/api/Transactions",
	"ActionWebservice": "http://localhost:65059/api/Actions",
	"CashOperationWebservice": "http://localhost:65059/api/CashOperations",
	"TimeClockWebservice": "http://localhost:65059/api/TimeClocks",
	"DataWebservice": "http://localhost:65059/api/Data",
	"TimerInterval": 500,
	"DatabaseTimeout": 30,
	"DatabaseTimeoutInterval": 10,
	"DelayAfterDatabaseError": 10,
	"DelayDeleteNotServedTransaction": 40,
	"Rows": 500,
	"SenderTimerInterval": 1000,
	"MaxRowsToSend": 25,
	"MaxSenderQueues": 250,
	"CompressWebRequest": true,
	"ControllerWebURL": "http://127.0.0.1:81/"
	}
	\end{lstlisting}
	\caption{Zawartość pliku konfiguracyjnego - PreParser.}
	\label{lst:przykladowyPlikKonfiguracyjnyPreParser}
\end{figure}
Skrócony opis poszczególnych parametrów:
\begin{itemize}
	\item ProcessID - id procesu działającego na danym kontrolerze
	\item ParserType - typ parsera komunikującego się z kontrolerem
	\item ObjectsConnectionString - parametry połączenia do tabeli EZ360Objects w bazie danych
	\item CommunicationConnectionString - parametry połączenia do tabeli EZ360Communication w bazie danych
	\item TransactionWebservice - adres url do webservice-u obsługującego transakcje
	\item ActionWebservice - adres url do webservice-u obsługującego akcje
	\item CashOperationWebservice - adres url do webservice-u obsługującego wpłaty/wypłaty
	\item TimeClockWebservice - adres url do webservice-u obsługującego obecności pracowników
	\item DataWebservice - adres url do webservice-u obsługującego dane dodatkowe
	\item TimerInterval - czas pomiędzy kolejnymi sprawdzeniami czy nie przyszły nowe zdarzenia (w milisekundach)
	\item DatabaseTimeout - maksymalny czas w jakim może zostać wykonywane zapytanie do bazy danych (w sekundach)
	\item DatabaseTimeoutInterval - przerwa pomiędzy kolejnymi zapytaniami do bazy danych (w sekundach)
	\item DelayAfterDatabaseError - czas do ponownej próby połączenia z bazą danych po wystąpieniu błędu
	\item DelayDeleteNotServedTransaction - czas po jakim nieobsługiwana transakcja jest usuwana
	\item Rows - maksymalna liczba wierszy możliwa do procesowania
	\item SenderTimerInterval - interwał z jakim wysyłane są dane do bazy
	\item MaxRowsToSend - maksymalna liczba wierszy przesłana w jednym zapytaniu
	\item MaxSenderQueues - limit liczby obiektów w kolejce do wysłania
	\item CompressWebRequest - kompresowanie wysyłanych danych
	\item ControllerWebURL - adres URL kontrolera
\end{itemize}
\subsection{Instalacja Parser-a po stronie administratora}
\newpage Poprawna instalacja modułu właściwego przetwarzania danych na komputerze administratora wymaga ręcznego rozpakowania archiwum AlohaParserVERSION.zip, gdzie VERSION jest numerem wersji. Po rozpakowaniu archiwum w miejsce wybrane przez administratora, powinny być dostępne pliki (rys. \ref{fig:aloha_parser_content}) potrzebne do uruchomienia modułu właściwego przetwarzania danych.
Aplikacje można uruchomić otwierając plik EZ360ParserUI.exe.
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/aloha_parser_content.png}
	\caption{Zawartość archiwum AlohaParserVERSION.}
	\label{fig:aloha_parser_content}
\end{figure}
Następnie należy dokonać konfiguracji zainstalowanej aplikacji. W tym celu otwieramy plik configuration.json. Powinien on mieć format przedstawiony na listingu \ref{lst:przykladowyPlikKonfiguracyjnyParser}.
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	"ProcessID": 444,
	"ParserType": "ALOHA",
	"Enabled": false,
	"DBConnections": {
	"AccessConnectionString": "Data Source = M-STOLECKI\\EZUniverse; User ID = sa; Password = prestigo123!; Initial Catalog = EZ360Access",
	"CommunicationConnectionString": "Data Source = M-STOLECKI\\EZUniverse; User ID = sa; Password = prestigo123!; Initial Catalog = EZ360Communication",
	"LaborConnectionString": "Data Source = M-STOLECKI\\EZUniverse; User ID = sa; Password = prestigo123!; Initial Catalog = EZ360Labor",
	"ObjectsConnectionString": "Data Source = M-STOLECKI\\EZUniverse; User ID = sa;Password = prestigo123!; Initial Catalog = EZ360Objects",
	"SalesConnectionString": "Data Source = M-STOLECKI\\EZUniverse; User ID = sa; Password = prestigo123!; Initial Catalog = EZ360Sales",
	"ReportsConnectionString": "Data Source = M-STOLECKI\\EZUniverse; User ID = sa; Password = prestigo123!; Initial Catalog = EZ360Reports",      
	"ApplicationsConnectionString": "Data Source = M-STOLECKI\\EZUniverse; User ID = sa; Password = prestigo123!; Initial Catalog = EZ360Applications"
	},
	"TimerInterval": 1000,
	"DatabaseTimeout": 10,
	"DatabaseTimeoutInterval": 10,
	"DelayAfterDatabaseError": 5000,
	"EnablePreserveSavedTransactions": false,
	"DeletePreservedTransactionsAfter": 24,
	"VideoTimeOffset": -10,
	"IdentificationPrefix" : "",
	"IdentificationNumber" : "",
	"Actions": {
	"Enabled": false,
	"Rows": 100
	},
	"CashOperations": {
	"Enabled": true,
	"Rows": 100
	},
	"Transactions": {
	"Enabled": true,
	"Rows": 100
	},
	"TimeClocks": {
	"Enabled": true,
	"Rows": 100
	},
	"Data": {
	"Enabled": true,
	"Rows": 100
	}
	\end{lstlisting}
	\caption{Zawartość pliku konfiguracyjnego - Parser - wycinek dotyczący kasy Aloha.}
	\label{lst:przykladowyPlikKonfiguracyjnyParser}
\end{figure}
Skrócony opis poszczególnych parametrów:
\begin{itemize}
	\item ProcessID - id procesu działającego na komputerze administratora
	\item ParserType - typ parsera, którego dotyczy konfiguracja
	\item AccessConnectionString - parametry połączenia do tabeli EZ360Access w bazie danych
	\item CommunicationConnectionString - parametry połączenia do tabeli EZ360Communication w bazie danych
	\item LaborConnectionString - parametry połączenia do tabeli EZ360Labor w bazie danych
	\item ObjectsConnectionString - parametry połączenia do tabeli EZ360Objects w bazie danych
	\item SalesConnectionString - parametry połączenia do tabeli EZ360Sales w bazie danych
	\item ReportsConnectionString - parametry połączenia do tabeli EZ360Reports w bazie danych
	\item ApplicationsConnectionString - parametry połączenia do tabeli EZ360Applications w bazie danych
	\item TimerInterval - czas pomiędzy kolejnymi sprawdzeniami czy nie przyszły nowe dane (w milisekundach)
	\item DatabaseTimeout - maksymalny czas w jakim może zostać wykonywane zapytanie do bazy danych (w sekundach)
	\item DatabaseTimeoutInterval - przerwa pomiędzy kolejnymi zapytaniami do bazy danych (w sekundach)
	\item DelayAfterDatabaseError - czas do ponownej próby połączenia z bazą danych po wystąpieniu błędu
	\item EnablePreserveSaveTransactions - definiuje czy włączyć funkcjonalność zachowywania transakcji
	\item DeletePreserveTransactionsAfter - definiuje po jakim czasie powinny być usuwane zachowane transakcje (podane w godzinach) 
	\item Rows - maksymalna liczba wierszy możliwa do procesowania
	\item VideoTimeOffset - przesunięcie w minutach uwzględniane przy wyliczaniu czasu wideo
	\item IdentificationPrefix - prefix pomagający zidentyfikować dane
	\item IdentificationNumer - numer pomagający zidentyfikować dane
	\item Dalsze ustawienia definiują, które typy danych powinny być przetwarzane
\end{itemize}
\section{Obsługa systemu i administrowanie nim}
\subsection{PreParser}
\subsubsection{Startowanie serwisu}
Startowanie serwisu realizowane z wykorzystaniem systemu operacyjnego Windows. Poprawne wystartowanie modułu wstępnego przetwarzania (po jego odpowiedniej konfiguracji) sprowadza się do uruchomienia serwisu za pośrednictwem menadżera serwisów systemu Windows (proces został zaprezentowany na rys. \ref{fig:startowanie_serwisu})
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/startowanie_serwisu.png}
	\caption{Przykład startowania serwisu.}
	\label{fig:startowanie_serwisu}
\end{figure}
\subsubsection{Zatrzymywanie serwisu}
Zatrzymywanie preparsera realizowane jest podobnie jak jego startowanie. Wykorzystuje się do tego również menadżer serwisów Windows.
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/zatrzymywanie_serwisu.png}
	\caption{Przykład zatrzymywania serwisu.}
	\label{fig:zatrzymywanie_serwisu}
\end{figure}
\subsubsection{Dezinstalacja serwisu}
W celu usunięcia serwisu z systemu operacyjnego należy uruchomić wiersz poleceń systemu Windows, a następnie przejść do katalogu gdzie został zainstalowany serwis. Po dokonaniu wyżej opisach czynności należy dokonać dezinstalacji poleceniem: \newline
EZ360PreParserService.exe -uninstall \newline
Spowoduje one usunięcie serwisu z systemu. 
\subsubsection{Diagnostyka i logowanie}
Serwis podczas pracy regularnie generuje szereg komunikatów o statusie swojego działania i aktywności.
Są one zapisywane w plikach logów, które przechowywane są w folderze "logs". Przechowywanych jest do 30 plików logów, które następnie po pojawieniu się następnych logów są usuwane.
Wyróżniamy następujące typy wiadomości składowanych w logach:
\begin{itemize}
	\item INFO - informuję użytkownika o statusie działa serwisu
	\item WARN - komunikuje pojawienie się problemu podczas analizy danych, co w większości przypadków oznacza brak wsparcia dla konkretnego typu danych i nie powoduje błędnego działania systemu
	\item ERROR - zawiadamia o wystąpieniu poważnego problemu, który powinien zostać zgłoszony do administratora w celu jego rozwiązania
\end{itemize}
\subsection{Parser}
\subsubsection{Uruchamianie aplikacji}
W celu uruchomienia aplikacji należy otworzyć plik EZ360ParserUI.exe, następnie dokonać inicjalizacji poprzez kliknięcie odpowiedniego przycisku (rys. \ref{fig:inicjalizacja_aplikacji}).
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/inicjalizacja_aplikacji.png}
	\caption{Inicjalizacja aplikacji.}
	\label{fig:inicjalizacja_aplikacji}
\end{figure}
Po poprawnej inicjalizacji modułu, wystarczy wcisnąć przycisk start, by rozpocząć proces przetwarzania danych (rys. \ref{fig:startowanie_aplikacji}).
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/startowanie_aplikacji.png}
	\caption{Startowanie aplikacji.}
	\label{fig:startowanie_aplikacji}
\end{figure}
\subsubsection{Zatrzymywanie aplikacji}
Administrator może w każdej chwili zatrzymać moduł właściwego przetwarzania danych. W celu dokonania tego, należy kliknąć przycisk STOP (rys. \ref{fig:zatrzymywanie_aplikacji}). Aplikacja dokończy obecny proces przetwarzania i wyśle dane, następnie zatrzyma się (trwa to około kilka sekund, zależnie od ilości procesowanych danych).
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/zatrzymywanie_aplikacji.png}
	\caption{Zatrzymywanie aplikacji.}
	\label{fig:zatrzymywanie_aplikacji}
\end{figure}
\subsubsection{Dezinstalacja aplikacji}
Dezinstalacja aplikacji sprowadza się do usunięcia zawartości folderu, w którym został zainstalowany moduł. Należy przy tym pamiętać, by wcześniej zatrzymać Parser i zamknąć aplikację.
\subsubsection{Diagnostyka i logowanie}
Podobnie jak w przypadku modułu wstępnego przetwarzania, tutaj również zaimplementowano system logowania komunikatów. Komunikaty informujące o stanie działania aplikacji przechowywane są w folderze "logs" oraz wyświetlane w interfejsie użytkownika, który udostępnia oprogramowanie. W tym wypadku typy komunikatów wyświetlane użytkownikowi są określane przez odpowiedni kolor czcionki:
 \begin{itemize}
 	\item INFO - Czarny
 	\item WARN - Zielony
 	\item ERROR - Czerwony
 \end{itemize}
\section{Bezpieczeństwo}
Ważną kwestią uwzględnianą podczas procesu tworzenia oprogramowania będącego przedmiotem niniejszej pracy jest bezpieczeństwo. W celu zapewnienia uwarunkowań sprzyjających bezpieczeństwu przetwarzanych danych moduł właściwego przetwarzania oraz wszystkie bazy przechowujące informacje przychodzące od strony użytkownika składowane są po stronie administratora systemu. Zapewnia on szereg zabezpieczeń i ciągłe wsparcie techniczne. Po stronie użytkownika zainstalowany jest tylko serwis modułu wstępnego przetwarzania na kontrolerze, który tylko przetwarzana lokalne dane i wysyła je do głównego centrum danych, więc nie ma możliwości dostępu do informacji zgromadzonych przez innych użytkowników.
\section{Przykład działania}
 \begin{itemize}
	\item Startowanie preparsera \ref{fig:startowanie_serwisu}
	\item Zatrzymywanie preparser \ref{fig:zatrzymywanie_serwisu}
	\item Startowanie aplikacji \ref{fig:startowanie_aplikacji}
	\item Zatrzymywanie aplikacji \ref*{fig:zatrzymywanie_aplikacji}
	\item Logi modułu wstępnego przetwarzania \ref{fig:preparser_log}
	\item Logi modułu właściwego przetwarzania \ref{fig:parser_log}
\end{itemize}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/preparser_log.png}
	\caption{Logi preparsera.}
	\label{fig:preparser_log}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/parser_log.png}
	\caption{Logi parsera.}
	\label{fig:parser_log}
\end{figure}
\chapter{Specyfikacja wewnętrzna}
W niniejszym rozdziale podjęta została kwestia architektury oprogramowania. Przedstawione zostały schematy baz danych oraz zakres wykorzystywanych bibliotek. Rozpisano również model ważniejszych klas oraz szczegółowo omówione zostały dane wejściowe wraz algorytmami koniecznymi do ich odpowiedniej analizy.
\section{Architektura systemu}
Schemat (rys. \ref{fig:schemat_przeplywu_danych}) przedstawia przepływ danych w systemie realizującym przetwarzanie informacji z kas Aloha.
Jak już wielokrotnie wspominano w niniejszej pracy, dane wychodzące z terminala kasy Aloha mają pewną ścieżkę, którą muszą pokonać zanim zostaną one przekształcone w model, mogący być prezentowany użytkownikowi i analizowany przez niego. Wspominany proces wygląda następująco:
 \begin{itemize}
	\item Terminal kasy Aloha wysyła komunikat o zdarzeniu
	\item AlohaSpyRelay przechwytuje informację przychodzącą z terminala i przetwarza ją na format rozpoznawalny przez moduł wstępnego przetwarzania
	\item Moduł wstępnego przetwarzania zainstalowany na kontrolerze odczytuje dane przychodzące z terminala i opracowane przez AlohaSpyRelay, a następnie dokonuje ich wstępnej analizy
	\item Dane wynikowe z PreParser przekazywane są do EZ360DataInterface, który przesyła je do bazy danych ulokowanej po stronie administratora systemu
	\item Moduł właściwego przetwarzania danych, odczytuje z bazy wiadomości i przetwarza je na format mogący być analizowany i oglądany przez użytkownika
	\item Dane wyjściowe z Parsersa prezentowane są w aplikacji webowej, będącej częścią systemu 360iQ dostarczanego przez firmę EZUniverse
\end{itemize}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/schemat_przeplywu_danych.png}
	\caption{Schemat przepływu danych.}
	\label{fig:schemat_przeplywu_danych}
\end{figure}
\section{Organizacja i struktura baz danych}
Moduł wstępnego przetwarzania danych:
 \begin{itemize}
	\item RAWDATA
	\item ALOHATransactions
	\item ALOHACashOperations
	\item ALOHATimeClocks
	\item ALOHAData
	\item ALOHAActions
\end{itemize}
Schemat bazy danych - \ref{fig:preparser_database_schema}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/preparser_database_schema.png}
	\caption{Schemat bazy danych dla modułu wstępnego przetwarzania.}
	\label{fig:preparser_database_schema}
\end{figure}
\newline
Moduł właściwego przetwarzania danych:
\begin{itemize}
	\item Transactions
	\item TransactionProducts
	\item TransactionPayments
	\item TransactionDiscounts
	\item TransactionReceipts
	\item TransactioActions
\end{itemize}
Schemat bazy danych - \ref{fig:parser_database_schema}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/parser_database_schema.png}
	\caption{Schemat bazy danych dla modułu właściwego przetwarzania.}
	\label{fig:parser_database_schema}
\end{figure} 
\section{Wykorzystane biblioteki}
Podczas realizowania zagadnienia omówionego w niniejszej pracy korzystano z następujących bibliotek .NET:
\begin{itemize}
	\item Microsoft.AspNet.WebApi.Client
	\item Microsoft.Bcl
	\item Microsoft.Bcl.Build
	\item Microsoft.Net.Http
	\item Newtonsoft.Json
	\item System.ValueTuple
\end{itemize}
Wszystkie wyżej wymienione biblioteki są udostępnia przez menadżer pakietów NuGet, będący zintegrowany z Visual Studio.
\section{Model klas}
Niniejsza sekcja opisuje najważniejsze klasy wykorzystywane w projekcie. W zależności od modułu są to:
\begin{itemize}
	\item Moduł wstępnego przetwarzania danych (schemat \ref{fig:preparser_diagram_klas})
	\subitem PreParser
	\subitem AlohaPreParser
	\subitem TransactionPreParser
	\subitem TimeClockPreParser
	\subitem CashDropPreParser
	\item Moduł właściwego przetwarzania danych (schemat \ref{fig:parser_diagram_klas})
	\subitem Parser
	\subitem AlohaParser
	\subitem TransactionParser
	\subitem TimeClockParser
	\subitem CashDropParser
	\subitem DataParser
\end{itemize}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/preparser_diagram_klas.png}
	\caption{Diagram przedstawiający najważniejsze klasy - PreParser.}
	\label{fig:preparser_diagram_klas}
\end{figure}
\begin{figure}[h]
	\centering
	\includegraphics[width=\textwidth]{./img/parser_diagram_klas.png}
	\caption{Diagram przedstawiający najważniejsze klasy - Parser.}
	\label{fig:parser_diagram_klas}
\end{figure}
\section{Szczegółowa analiza danych wejściowych}
Na podstawie przykładowych danych wejściowych przestawionych na listingu \ref{lst:przykladoweZdarzenieAloha2}. Każde zdarzenie w formacie XML zawiera następujące atrybuty:
\begin{itemize}
	\item TerminalID - numer terminala kasowego
	\item EventTime - czas wystąpienia zdarzenia
	\item EmployeeID - ID pracownika
	\item EmployeeName - imię i nazwisko pracownika
	\item ManagerID - ID managera
	\item ManagerName - imię i nazwisko managera
	\item TableID - ID stanowiska, na którym ulokowany jest terminal
	\item CheckID - numer transakcji
	\item TransactionTypeID - ID typu zdarzenia
	\item TransactionType - nazwa typu zdarzenia
	\item Description - opis zdarzenia
	\item Amount - wartość pieniężna związana ze zdarzeniem
	\item Quantity - ilość sztuk (w przypadku produktów i płatności)
	\item Sender - adres IP urządzenia wysyłającego
	\item ReceivedOn - data otrzymania zdarzenia po stronie kontrolera
\end{itemize}
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	<SpyMessage TerminalID="4" EventTime="23:59:57" EmployeeID="94205" EmployeeName="AHMET B?RL?K" ManagerID="0" ManagerName="" TableID="4194420" CheckID="40116" TransactionTypeID="59" TransactionType="TOTAL" Description="" Amount="18.75" Quantity="0" Sender="192.168.100.4" ReceivedOn="2017.11.30 00:00:08.204" />
	\end{lstlisting}
	\caption{Przykładowe zdarzenie - dane wejściowe Aloha.}
	\label{lst:przykladoweZdarzenieAloha2}
\end{figure}
\section{Algorytmy}
W systemie wykorzystane zostały następujące algorytmy przetwarzające i rozszerzające dane wejściowe w formacie XML:
\begin{itemize}
	\item Dodawanie brakujących przedmiotów będących częścią promocji do transakcji (listing został podzielony na części - kolejno: \ref{lst:brakujaceProdukty1}, \ref{lst:brakujaceProdukty2}, \ref{lst:brakujaceProdukty3})
	\item Rozszerzanie zdarzenia XML o rozszerzone nazwy przedmiotów i wartości podatków (listing został podzielony na części - kolejno: \ref{lst:rozszerzanieXML1}, \ref{lst:rozszerzanieXML2}, \ref{lst:rozszerzanieXML3})
\end{itemize}
\subsection{Dodawanie brakujących przedmiotów będących częścią promocji do transakcji}
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	private void ProcessAddPromo(XElement action, XElement lastAction, List<SpyMessage> actions,
	List<PromotionBundle> promotionBundles, List<string> warningMessages, List<SpyMessage> result)
	{
	var listOfActions = actions.Select(x => x.Body).ToList();
	var lastActionTransactionType = lastAction?.Attribute("TransactionType")?.Value ?? string.Empty;
	if (lastActionTransactionType == "DELETE_PROMO")
	{
	var actionsOffset = 2;
	var cancelItemActionAppeared = false;
	var addItemActionAppeared = false;
	for (var i = 1; i < actionsOffset + 1; i++)
	{
	var indexToMove = listOfActions.IndexOf(lastAction) - i;
	if (indexToMove >= 0)
	{
	var currentAction = actions.ElementAt(indexToMove).Body;
	var currentActionName = currentAction?.Attribute("TransactionType")?.Value ?? string.Empty;
	if (currentActionName.StartsWith("6") || currentActionName.StartsWith("7"))
	{
	actionsOffset++;
	}
	
	if (currentActionName == "ADD_ITEM" && cancelItemActionAppeared)
	{
	addItemActionAppeared = true;
	break;
	}
	
	if (currentActionName == "CANCEL_ITEM" && !addItemActionAppeared)
	{
	cancelItemActionAppeared = true;
	}
	}
	else
	{
	break;
	}
	}
	\end{lstlisting}
	\caption{Dodawanie brakujących przedmiotów będących częścią promocji do transakcji - 1}
	\label{lst:brakujaceProdukty1}
\end{figure}
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	if (addItemActionAppeared)
	{
	IsPromoChanged = true;
	AreItemsAlreadyAdded = true;
	warningMessages.Add(
	$"Promotion change found for transaction at CheckID = {action?.Attribute("CheckID")?.Value ?? string.Empty} and EventTime = {action?.Attribute("EventTime")?.Value ?? string.Empty}.");
	}
	}	
	if (!AreItemsAlreadyAdded)
	{
	var promoName = action?.Attribute("Description")?.Value ?? string.Empty;
	var itemsMultiplier = 1;
	if (promoName.StartsWith("2 for"))
	{
	itemsMultiplier = 2;
	}
	var bundle =
	promotionBundles.FirstOrDefault(x => x.PromotionName.ToUpperInvariant() ==
	promoName.ToUpperInvariant());
	var count = 1;
	var spyMessage = actions.FirstOrDefault(x => x.Body == action);
	if (bundle != null)
	{
	foreach (var product in bundle.ProductsInPromotion)
	{
	var element = new XElement(action);
	element.SetAttributeValue("TransactionType", "ADD_ITEM");
	element.SetAttributeValue("TransactionTypeID", "8");
	element.SetAttributeValue("Quantity", "1");
	element.SetAttributeValue("Description", product.Name);
	element.SetAttributeValue("Amount", product.DisplayAs);
	element.Add(new XAttribute("ItemId", product.PLU));
	element.Add(new XAttribute("ItemName", product.Name));
	var message = new SpyMessage
	{
	Body = element,
	CheckID = long.Parse(element?.Attribute("CheckID")?.Value),
	RawDataID = -1,
	TransactionType = element?.Attribute("TransactionType")?.Value ?? string.Empty,
	LastActionDate = actions.ElementAt(actions.IndexOf(spyMessage)).LastActionDate,
	UtcTime = actions.ElementAt(actions.IndexOf(spyMessage)).UtcTime
	};
	\end{lstlisting}
	\caption{Dodawanie brakujących przedmiotów będących częścią promocji do transakcji - 2}
	\label{lst:brakujaceProdukty2}
\end{figure}
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	for (var i = 0; i < itemsMultiplier; i++)
	{
	result.Add(message);
	count++;
	}
	}
	warningMessages.Add(
	$"Promotion added {promoName} and EventTime = {action?.Attribute("EventTime")?.Value ?? string.Empty}. Added new events that add proper products for promotion");
	}
	else
	{
	warningMessages.Add(
	$"Not found bundle: {promoName} in bundle collection for action's CheckID: {action?.Attribute("CheckID")?.Value ?? string.Empty}.");
	}
	}
	
	AreItemsAlreadyAdded = false;
	}
	\end{lstlisting}
	\caption{Dodawanie brakujących przedmiotów będących częścią promocji do transakcji - 3}
	\label{lst:brakujaceProdukty3}
\end{figure}
\subsection{Rozszerzanie zdarzenia XML o rozszerzone nazwy przedmiotów i wartości podatków}
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	private void ExtendMessegeWithAdditionalItemInfo(XElement action, XElement itemCategoryXML, List<TaxInformation> taxInformations, List<PromotionBundle> promotionBundles)
	{
	var itemName = action?.Attribute("Description")?.Value ?? string.Empty;
	if (itemCategoryXML != null)
	{
	var itemNodes = itemCategoryXML.Elements();
	action.Add(new XAttribute("ItemId", string.Empty));
	action.Add(new XAttribute("ItemShortName", string.Empty));
	action.Add(new XAttribute("ItemLongName", string.Empty));
	action.Add(new XAttribute("ItemLongName2", string.Empty));
	action.Add(new XAttribute("ItemChitName", string.Empty));
	action.Add(new XAttribute("ItemName", string.Empty));
	action.Add(new XAttribute("Tax", "0"));
	foreach (var item in itemNodes)
	{
	var itemShortName = item?.Attribute("ItemShortName")?.Value ?? string.Empty;
	var itemLongName = item?.Attribute("ItemLongName")?.Value ?? string.Empty;
	var itemLongName2 = item?.Attribute("ItemLongName2")?.Value ?? string.Empty;
	var itemChitName = item?.Attribute("ItemChitName")?.Value ?? string.Empty;
	var itemNameAttr = item?.Attribute("ItemName")?.Value ?? string.Empty;	
	if (!string.IsNullOrEmpty(itemShortName) && itemShortName == itemName
	|| !string.IsNullOrEmpty(itemLongName) && itemLongName == itemName
	|| !string.IsNullOrEmpty(itemLongName2) && itemLongName2 == itemName
	|| !string.IsNullOrEmpty(itemChitName) && itemChitName == itemName
	|| !string.IsNullOrEmpty(itemNameAttr) && itemNameAttr == itemName)
	{
	action.SetAttributeValue("ItemId", item?.Attribute("ItemId")?.Value ?? string.Empty);
	action.SetAttributeValue("ItemShortName", itemShortName);
	action.SetAttributeValue("ItemLongName", itemLongName);
	action.SetAttributeValue("ItemLongName2", itemLongName2);
	action.SetAttributeValue("ItemChitName", itemChitName);
	action.SetAttributeValue("ItemName", itemNameAttr);
	\end{lstlisting}
	\caption{Rozszerzanie zdarzenia XML o rozszerzone nazwy przedmiotów i wartości podatków. - 1}
	\label{lst:rozszerzanieXML1}
\end{figure}
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	
	if (taxInformations != null)
	{
	var taxId = item?.Attribute("ItemTaxId")?.Value ?? "0";
	var tax = taxInformations.FirstOrDefault(x => x.TaxId == taxId);
	if (tax != null)
	{
	if (decimal.TryParse(
	action?.Attribute("Amount")?.Value ?? "0",
	NumberStyles.Any,
	CultureInfo.InvariantCulture,
	out var amountValue))
	{
	var taxValue = amountValue * tax.TaxRate;
	action.SetAttributeValue("Tax", taxValue.ToString(CultureInfo.InvariantCulture));
	}
	}
	}
	}
	}
	}
	else
	{
	var itemsInPromotions = promotionBundles.Select(x => x.ProductsInPromotion).ToList();
	var items = new List<Product>();
	foreach (var itemsInPromotion in itemsInPromotions)
	{
	foreach (var itemInPromotion in itemsInPromotion)
	{
	if (!items.Any(x => x.PLU == itemInPromotion.PLU))
	{
	items.Add(itemInPromotion);
	}
	}
	}
	action.Add(new XAttribute("ItemId", string.Empty));
	action.Add(new XAttribute("ItemShortName", string.Empty));
	action.Add(new XAttribute("ItemLongName", string.Empty));
	action.Add(new XAttribute("ItemLongName2", string.Empty));
	action.Add(new XAttribute("ItemChitName", string.Empty));
	action.Add(new XAttribute("ItemName", string.Empty));
	action.Add(new XAttribute("Tax", "0"));
	\end{lstlisting}
	\caption{Rozszerzanie zdarzenia XML o rozszerzone nazwy przedmiotów i wartości podatków. - 2}
	\label{lst:rozszerzanieXML2}
\end{figure}
\begin{figure}[h]
	\begin{lstlisting}[frame=single, breaklines=true]
	foreach (var item in items)
	{
	if (!string.IsNullOrEmpty(item.ShortName) && item.ShortName == itemName
	|| !string.IsNullOrEmpty(item.LongName) && item.LongName == itemName
	|| !string.IsNullOrEmpty(item.Name) && item.Name == itemName)
	{
	action.SetAttributeValue("ItemId", item.PLU);
	action.SetAttributeValue("ItemShortName", item.ShortName);
	action.SetAttributeValue("ItemLongName", item.LongName);
	action.SetAttributeValue("ItemLongName2", string.Empty);
	action.SetAttributeValue("ItemChitName", string.Empty);
	action.SetAttributeValue("ItemName", item.Name);
	}
	}
	}
	}
	\end{lstlisting}
	\caption{Rozszerzanie zdarzenia XML o rozszerzone nazwy przedmiotów i wartości podatków. - 3}
	\label{lst:rozszerzanieXML3}
\end{figure}
\chapter{Testowanie i uruchamianie}
\section {PreParser}
\section {Parser}
Sposób testowania w ramach pracy (organizacja eksperymentów, przypadki testowe, wyniki, zakres testowania -- pełny/niepełny)

Poniżej przykład tworzenia tabeli. Podobnie jak w przypadku rysunków, każdą tabelę należy opisać w treśći pracy i odpowiednio się do niej odwołać.

\begin{table}
	\centering
	\caption{Nagłówek tabeli.}
	\begin{tabular}{|c|l|r|}
		\hline
		Pierwsza kolumna & Druga kolumna & Trzecia kolumna \\
		\hline
		3 & 4 & 5 \\
		\hline 
	\end{tabular}
	\label{tab:przyklad_tabeli}
\end{table}

\chapter{Uwagi o przebiegu i~wynikach prac}
\section {Stopień realizacji zagadnienia}
\section{Napotkane problemy}
\section{Dalszy rozwój}

\chapter{Podsumowanie}


Przeczytaj poniższy tekst przed oddaniem pracy do sprawdzenia:

\ksremark{W całej pracy należy zapewnić, że nie pojawiają się sieroty - pojedyncze litery na końcu linii. W tym celu należy korzystać z symbolu tyldy po każdej takiej literze.}

\ksremark{Nie powinno być odstępów między akapitami. Jeżeli tak się dzieje, oznacza to złe ułożenie obrazków. Wtedy wystarczy określić, gdzie powinien taki obraz się znajdować (np. na górze/dole strony). Innym rozwiązaniem jest dodanie komendy 'newpage' na końcu strony.}

\ksremark{Proszę nie używać słownictwa w języku obcym - większość słów ma swój polski odpowiednik.}	


\ksremark{Proszę nie używać apostrofów w roli cudzysłowia.}	

\ksremark{W przypadku stosowania różnych czcionek (kursywy czy pogrubień) proszę trzymać się jednej konwencji w całej pracy.}	

\ksremark{Wprowadzająć pojęcie należy podać najpierw jego polską nazwę, następnie w nawiasie angielską i ewentualny skrót. Od takiej definicji skrótu można z niego korzystać w dalszej części pracy. Np. Jako algorytm uczacy wybrałem metodę wektorów wspierających (ang. Support Vector Machine, SVM). SVM jest często stosowany do ...}	

\bibliographystyle{plain}
\bibliography{bibliografia}	
	
\end{document}
